#!/bin/bash

#
# Helper script that setups a test Atoma network environment on Sui
#
# Prerequisites (see the README.md):
# - Publish the package to the Sui network
# - Mint yourself some TOMA tokens
#
# Usage: ./oneclicksetup.sh <package ID>
#
# When this script is done, we will have a model named "llama" with one echelon
# ID 1, and a node registered to that model echelon.
#

package="${1}"

# if package is not provided or does not start with 0x, exit
if [ -z "${package}" ] || [[ ! "${package}" =~ ^0x ]]; then
    echo "Usage: ./oneclicksetup.sh <package ID>"
    exit 1
fi

function abs_path_to_git_root_dir() {
    # Recursively find the repo root directory so that this script can be called
    # from anywhere

    if [ -d "atoma-contracts" ]; then
        echo "$(pwd)/atoma-contracts"
    elif [ "$(pwd)" == "/" ]; then
        echo "No atoma-contracts directory found"
        exit 1
    else
        cd ..
        abs_path_to_git_root_dir
    fi
}

entrance_dir=$(pwd)
root_dir=$(abs_path_to_git_root_dir)

cd $root_dir/sui/dev

# These commands follow the README.md

./cli --wallet ~/.sui/sui_config/client.yaml \
    db add-model \
    --package "${package}" \
    --model-name "llama"

./cli --wallet ~/.sui/sui_config/client.yaml \
    db add-model-echelon \
    --package "${package}" \
    --model-name "llama" \
    --echelon 1 \
    --fee-in-protocol-token 1000 \
    --relative-performance 100

./cli --wallet ~/.sui/sui_config/client.yaml \
    db set-required-registration-toma-collateral \
    --package "${package}" \
    --new-amount 1

# Now we are assuming you minted yourself some TOMA tokens

./cli --wallet ~/.sui/sui_config/client.yaml \
    db register-node \
    --package "${package}"

./cli --wallet ~/.sui/sui_config/client.yaml \
    db add-node-to-model \
    --package "${package}" \
    --model-name "llama" \
    --echelon 1

# leave the caller where they started
cd $entrance_dir
